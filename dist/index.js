/*! For license information please see index.js.LICENSE.txt */
module.exports=(()=>{var e={6854:e=>{var t={kind:"Document",definitions:[{kind:"ObjectTypeExtension",name:{kind:"Name",value:"Mutation"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"auth"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"AuthMutation"}}},directives:[]}]},{kind:"ObjectTypeExtension",name:{kind:"Name",value:"Subscription"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",description:{kind:"StringValue",value:"Called when the token with following id was revoked",block:!0},name:{kind:"Name",value:"tokenWasRevoked"},arguments:[{kind:"InputValueDefinition",name:{kind:"Name",value:"id"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]}]},{kind:"ObjectTypeDefinition",name:{kind:"Name",value:"AuthMutation"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",description:{kind:"StringValue",value:"Revoke some token",block:!0},name:{kind:"Name",value:"revokeToken"},arguments:[{kind:"InputValueDefinition",description:{kind:"StringValue",value:"Token ID",block:!0},name:{kind:"Name",value:"id"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"FieldDefinition",description:{kind:"StringValue",value:"Revoke All tokens",block:!0},name:{kind:"Name",value:"revokeAllTokens"},arguments:[{kind:"InputValueDefinition",description:{kind:"StringValue",value:'"\nAccount ID',block:!0},name:{kind:"Name",value:"account"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]}]}],loc:{start:0,end:417}};t.loc.source={body:'extend type Mutation {\n  auth: AuthMutation!\n}\n\nextend type Subscription {\n  """\n  Called when the token with following id was revoked\n  """\n  tokenWasRevoked (id: ID!): [ID!]!\n}\n\ntype AuthMutation {\n  """\n  Revoke some token\n  """\n  revokeToken(\n    """\n    Token ID\n    """\n    id: ID!\n  ): Boolean\n\n  """\n  Revoke All tokens\n  """\n  revokeAllTokens(\n    """"\n    Account ID\n    """\n    account: ID!\n  ): Boolean\n}\n',name:"GraphQL request",locationOffset:{line:1,column:1}},e.exports=t},5003:e=>{var t={kind:"Document",definitions:[{kind:"EnumTypeDefinition",description:{kind:"StringValue",value:"Standart ordering options",block:!0},name:{kind:"Name",value:"OrderDirection"},directives:[],values:[{kind:"EnumValueDefinition",name:{kind:"Name",value:"ASC"},directives:[]},{kind:"EnumValueDefinition",name:{kind:"Name",value:"DESC"},directives:[]}]},{kind:"InterfaceTypeDefinition",description:{kind:"StringValue",value:"Error handle interface",block:!0},name:{kind:"Name",value:"Error"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",description:{kind:"StringValue",value:"Error name. Can be short error message",block:!0},name:{kind:"Name",value:"name"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]},{kind:"FieldDefinition",description:{kind:"StringValue",value:"Error detail message string",block:!0},name:{kind:"Name",value:"msg"},arguments:[],type:{kind:"NamedType",name:{kind:"Name",value:"String"}},directives:[]}]},{kind:"ObjectTypeDefinition",description:{kind:"StringValue",value:"Information about pagination in a connection.",block:!0},name:{kind:"Name",value:"PageInfo"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"hasPreviousPage"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"hasNextPage"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"startCursor"},arguments:[],type:{kind:"NamedType",name:{kind:"Name",value:"String"}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"endCursor"},arguments:[],type:{kind:"NamedType",name:{kind:"Name",value:"String"}},directives:[]}]},{kind:"InterfaceTypeDefinition",description:{kind:"StringValue",value:"GraphQL Node spec. interface",block:!0},name:{kind:"Name",value:"Node"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"id"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"createdAt"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"DateTime"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"updatedAt"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"DateTime"}}},directives:[]}]},{kind:"InterfaceTypeDefinition",description:{kind:"StringValue",value:"GraphQL Edge spec. interface",block:!0},name:{kind:"Name",value:"Edge"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"node"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Node"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"cursor"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}]},{kind:"InterfaceTypeDefinition",description:{kind:"StringValue",value:"GraphQL Connection spec. interface",block:!0},name:{kind:"Name",value:"Connection"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"totalCount"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"pageInfo"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"PageInfo"}}},directives:[]},{kind:"FieldDefinition",name:{kind:"Name",value:"edges"},arguments:[],type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NamedType",name:{kind:"Name",value:"Edge"}}}},directives:[]}]},{kind:"InputObjectTypeDefinition",name:{kind:"Name",value:"BetweenDate"},directives:[],fields:[{kind:"InputValueDefinition",name:{kind:"Name",value:"start"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Date"}}},directives:[]},{kind:"InputValueDefinition",name:{kind:"Name",value:"end"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Date"}}},directives:[]}]},{kind:"InputObjectTypeDefinition",name:{kind:"Name",value:"BetweenTime"},directives:[],fields:[{kind:"InputValueDefinition",name:{kind:"Name",value:"start"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Time"}}},directives:[]},{kind:"InputValueDefinition",name:{kind:"Name",value:"end"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Time"}}},directives:[]}]},{kind:"InputObjectTypeDefinition",name:{kind:"Name",value:"BetweenDateTime"},directives:[],fields:[{kind:"InputValueDefinition",name:{kind:"Name",value:"start"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"DateTime"}}},directives:[]},{kind:"InputValueDefinition",name:{kind:"Name",value:"end"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"DateTime"}}},directives:[]}]},{kind:"InputObjectTypeDefinition",name:{kind:"Name",value:"BetweenInt"},directives:[],fields:[{kind:"InputValueDefinition",name:{kind:"Name",value:"start"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}},directives:[]},{kind:"InputValueDefinition",name:{kind:"Name",value:"end"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Int"}}},directives:[]}]},{kind:"InputObjectTypeDefinition",name:{kind:"Name",value:"BetweenMoney"},directives:[],fields:[{kind:"InputValueDefinition",name:{kind:"Name",value:"start"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Money"}}},directives:[]},{kind:"InputValueDefinition",name:{kind:"Name",value:"end"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Money"}}},directives:[]}]}],loc:{start:0,end:1012}};t.loc.source={body:'"""\nStandart ordering options\n"""\nenum OrderDirection {\n  ASC\n  DESC\n}\n\n"""\nError handle interface\n"""\ninterface Error {\n  """\n  Error name. Can be short error message\n  """\n  name: String!\n\n  """\n  Error detail message string\n  """\n  msg: String\n}\n\n\n"""\nInformation about pagination in a connection.\n"""\ntype PageInfo {\n  hasPreviousPage: Boolean!\n  hasNextPage: Boolean!\n  startCursor: String\n  endCursor: String\n}\n\n"""\nGraphQL Node spec. interface\n"""\ninterface Node {\n  id: ID!\n  createdAt: DateTime!\n  updatedAt: DateTime!\n}\n\n"""\nGraphQL Edge spec. interface\n"""\ninterface Edge {\n  node: Node!\n  cursor: String!\n}\n\n"""\nGraphQL Connection spec. interface\n"""\ninterface Connection {\n  totalCount: Int!\n  pageInfo: PageInfo!\n  edges: [Edge]!\n}\n\ninput BetweenDate {\n  start: Date!\n  end: Date!\n}\n\ninput BetweenTime {\n  start: Time!\n  end: Time!\n}\n\ninput BetweenDateTime {\n  start: DateTime!\n  end: DateTime!\n}\n\ninput BetweenInt {\n  start: Int!\n  end: Int!\n}\n\ninput BetweenMoney {\n  start: Money!\n  end: Money!\n}',name:"GraphQL request",locationOffset:{line:1,column:1}},e.exports=t},6719:e=>{var t={kind:"Document",definitions:[{kind:"ObjectTypeDefinition",name:{kind:"Name",value:"Query"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"info"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"InfoQuery"}}},directives:[]}]},{kind:"ObjectTypeDefinition",name:{kind:"Name",value:"Mutation"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"info"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"InfoMutation"}}},directives:[]}]},{kind:"ObjectTypeDefinition",name:{kind:"Name",value:"Subscription"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"info"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}]},{kind:"ObjectTypeDefinition",description:{kind:"StringValue",value:"Info module queries",block:!0},name:{kind:"Name",value:"InfoQuery"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",description:{kind:"StringValue",value:"Returns developer info",block:!0},name:{kind:"Name",value:"developer"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Developer"}}},directives:[]}]},{kind:"ObjectTypeDefinition",name:{kind:"Name",value:"InfoMutation"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",name:{kind:"Name",value:"echo"},arguments:[{kind:"InputValueDefinition",name:{kind:"Name",value:"str"},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}]},{kind:"ObjectTypeDefinition",description:{kind:"StringValue",value:"Developer info",block:!0},name:{kind:"Name",value:"Developer"},interfaces:[],directives:[],fields:[{kind:"FieldDefinition",description:{kind:"StringValue",value:"Returns developer company name",block:!0},name:{kind:"Name",value:"name"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]},{kind:"FieldDefinition",description:{kind:"StringValue",value:"Returns developer url",block:!0},name:{kind:"Name",value:"url"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"URL"}}},directives:[]},{kind:"FieldDefinition",description:{kind:"StringValue",value:"Returns developer email address",block:!0},name:{kind:"Name",value:"email"},arguments:[],type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"EmailAddress"}}},directives:[]}]}],loc:{start:0,end:506}};t.loc.source={body:'type Query {\n  info: InfoQuery!\n}\n\ntype Mutation {\n  info: InfoMutation!\n}\n\ntype Subscription {\n  info: String!\n}\n\n\n"""\nInfo module queries\n"""\ntype InfoQuery {\n\n  """\n  Returns developer info\n  """\n  developer: Developer!\n \n}\n\ntype InfoMutation {\n  echo(str: String!): String!\n}\n\n"""\nDeveloper info\n"""\ntype Developer {\n\n  """\n  Returns developer company name\n  """\n  name: String!\n\n  """\n  Returns developer url\n  """\n  url: URL!\n\n  """\n  Returns developer email address\n  """\n  email: EmailAddress!\n}\n\n\n',name:"GraphQL request",locationOffset:{line:1,column:1}},e.exports=t},8793:e=>{var t={kind:"Document",definitions:[{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"Money type.\nThe value is stored in the smallest monetary unit (kopecks, cents, etc.)\nReal type - Int\ne.g. For 250 USD this record returns value as 250000 (250$ * 100¢) ",block:!0},name:{kind:"Name",value:"Money"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"DateTime type.\nUse JavaScript Date object for date/time fields\nReal type - String",block:!0},name:{kind:"Name",value:"DateTime"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"DateTime type.\nUse JavaScript Date object for date fields\nReal type - String",block:!0},name:{kind:"Name",value:"Date"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"Time type.\nReal type - String",block:!0},name:{kind:"Name",value:"Time"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"URL type.\nA field whose value conforms to the standard URL format as specified in RFC3986: https://www.ietf.org/rfc/rfc3986.txt.\nReal type - String",block:!0},name:{kind:"Name",value:"URL"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"Email address type.\nA field whose value conforms to the standard internet email address format as specified in RFC822: https://www.w3.org/Protocols/rfc822/.\nReal type - String",block:!0},name:{kind:"Name",value:"EmailAddress"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"The JSON scalar type represents JSON values as specified by ECMA-404: http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf.",block:!0},name:{kind:"Name",value:"JSON"},directives:[]},{kind:"ScalarTypeDefinition",description:{kind:"StringValue",value:"The JSONObject scalar type represents JSON objects as specified by ECMA-404: http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf.",block:!0},name:{kind:"Name",value:"JSONObject"},directives:[]}],loc:{start:0,end:1165}};t.loc.source={body:'"""\nMoney type.\nThe value is stored in the smallest monetary unit (kopecks, cents, etc.)\nReal type - Int\ne.g. For 250 USD this record returns value as 250000 (250$ * 100¢) \n"""\nscalar Money\n\n"""\nDateTime type.\nUse JavaScript Date object for date/time fields\nReal type - String\n"""\nscalar DateTime\n\n"""\nDateTime type.\nUse JavaScript Date object for date fields\nReal type - String\n"""\nscalar Date\n\n"""\nTime type.\nReal type - String\n"""\nscalar Time\n\n"""\nURL type.\nA field whose value conforms to the standard URL format as specified in RFC3986: https://www.ietf.org/rfc/rfc3986.txt.\nReal type - String\n"""\nscalar URL\n\n"""\nEmail address type.\nA field whose value conforms to the standard internet email address format as specified in RFC822: https://www.w3.org/Protocols/rfc822/.\nReal type - String\n"""\nscalar EmailAddress\n\n"""\nThe JSON scalar type represents JSON values as specified by ECMA-404: http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf.\n"""\nscalar JSON\n\n"""\nThe JSONObject scalar type represents JSON objects as specified by ECMA-404: http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf.\n"""\nscalar JSONObject\n\n',name:"GraphQL request",locationOffset:{line:1,column:1}},e.exports=t},1400:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.withFilter=t.App=void 0;const o=i(n(5747)),a=i(n(8605)),s=i(n(7211)),u=i(n(5622)),d=n(630),l=n(2363),c=i(n(2242)),p=i(n(358)),f=i(n(479)),v=i(n(1050)),m=i(n(2127)),y=n(1800),h=i(n(5057)),g=n(9313),_=n(9967),k=n(1621),T=n(7071);Object.defineProperty(t,"withFilter",{enumerable:!0,get:function(){return T.withFilter}});const E=n(3373),N=i(n(6933)),b=i(n(2682)),O=n(6376),S=n(1231),w=n(531),D=n(265),A=n(9892),L=i(n(4384)),I=n(6737),M=n(2706),R=i(n(6980)),j=n(8026),P=n(5504),x=n(7684),F=n(8537),C=n(6158),G=n(690);class U{constructor(e){this.props=Object.assign({port:P.DEFAULT_SERVER_PORT,endpoint:P.DEFAULT_GRAPHQL_ENDPOINT,authEndpoint:P.DEFAULT_AUTH_ENDPOINT,timezone:P.DEFAULT_SERVER_TIMEZONE,subscriptionEndpoint:P.DEFAULT_GRAPHQL_SUBSCRIPTION_ENDPOINT,usePlayground:!1,enableIntrospection:!1,useVoyager:!1,debug:!1},e),this.props.sessions=!1!==this.props.sessions&&Object.assign({path:P.DEFAULT_SESSION_PATH,ttl:P.DEFAULT_SESSION_TTL,secret:P.DEFAULT_SESSION_SECRET},this.props.sessions),this.props.routes=Object.assign({voyager:P.DEFAULT_ROUTE_VOYAGER},this.props.routes)}bootstrap(e){const{port:t,usePlayground:n,useVoyager:r,endpoint:i,authEndpoint:o,routes:u,serverOptions:d,subscriptionEndpoint:l}=this.props,{app:c,schema:p,context:f}=this.createApp(),{logger:v}=f,m=null==d?void 0:d.cert;let y;process.on("warning",(e=>v.server.warn(e.name,e)));try{y=m?s.default.createServer(d||{},c):a.default.createServer(d||{},c)}catch(e){throw v.server.error("Failed to start server",{err:e}),new A.ServerError("Failed to start server",e)}const h=`http${m?"s":""}://localhost`;y.listen(t,(()=>{const a={graphql:`${h}:${t}${i}`,auth:`${h}:${t}${o}`,subscriptions:`ws${m?"s":""}://localhost:${t}${l}`};v.server.debug(`App server started at «${a.graphql}»`),v.server.debug(`Authentification server started at «${a.auth}»`),n&&(a.graphiql=`${h}:${t}${i}${P.DEFAULT_ROUTE_GRAPHIQL}`,v.server.debug(`Graphiql resolved at «${a.graphiql}»`)),r&&(a.voyager=`${h}:${t}${u.voyager}`,v.server.debug(`Voyager resolved at «${a.voyager}»`)),this.createSubscriptionServer({schema:p,server:y,context:f}),v.server.debug("Suscription server started at "+a.subscriptions),void 0!==e&&e({port:t,context:f,resolveUrl:a})}))}createSubscriptionServer(e){const{subscriptionEndpoint:t,websocketOptions:n}=this.props,{server:i,schema:o,context:a}=e,s=new R.default({context:a});return new O.SubscriptionServer({execute:g.execute,schema:o,subscribe:g.subscribe,onConnect:e=>r(this,void 0,void 0,(function*(){const t=R.default.extractTokenFromSubscription(e),n=yield s.verifyToken(t);if(!n)throw new A.UnauthorizedError("Invalid token");if(n.type!==j.TokenType.access)throw new A.UnauthorizedError("Is not an access token");return a.token=n,a})),onDisconnect:e=>{e.close(),e.terminate()}},Object.assign({server:i,path:t},n))}createApp(){const{typeDefs:e,resolvers:t,endpoint:n,authEndpoint:i,timezone:a,port:s,jwt:g,middlewares:T,database:O,expressMiddlewares:U,redis:V,logger:B,routes:q,subscriptionEndpoint:$,usePlayground:K,enableIntrospection:Q,useVoyager:J,serverOptions:z,debug:H,staticOptions:Z,sessions:X}=this.props,{cookieSign:W}=z||{};B.server.debug("Create application proc was started");const Y=m.default(),ee=l.makeExecutableSchema({typeDefs:[M.scalar.typeDefs,M.common.typeDefs,M.info.typeDefs,M.auth.typeDefs,...e||[]],resolvers:[M.scalar.resolvers,M.info.resolvers,M.auth.resolvers,...t||[]]}),te=D.knexProvider(Object.assign({localTimezone:a,logger:B},O));let ne,re,ie;F.CronJobManager.configure({logger:B});const oe=Object.assign({retryStrategy:e=>Math.min(50*e,2e4)},V);try{ne=new N.default(oe),re=new N.default(oe),ie=new N.default(oe)}catch(e){throw new A.ServerError("Failed to init Redis handle",{err:e})}ne.on("error",(e=>{B.server.error("Redis Common error "+e.errno,{err:e})})),re.on("error",(e=>{B.server.error("Redis Publisher error "+e.errno,{err:e})})),ie.on("error",(e=>{B.server.error("Redis Subscriber error "+e.errno,{err:e})})),ne.on("connect",(()=>{B.server.debug("Redis common connection is Done")})),re.on("connect",(()=>{B.server.debug("Redis Publisher connection is Done")})),ie.on("connect",(()=>{B.server.debug("Redis Subscriber connection is Done")})),ne.on("reconnecting",(()=>{B.server.debug("Redis common reconnecting")})),re.on("reconnecting",(()=>{B.server.debug("Redis Publisher reconnecting")})),ie.on("reconnecting",(()=>{B.server.debug("Redis Subscriber reconnecting")})),ne.on("close",(()=>{B.server.debug("Redis common close")})),re.on("close",(()=>{B.server.debug("Redis Publisher close")})),ie.on("close",(()=>{B.server.debug("Redis Subscriber close")}));const ae={endpoint:n,timezone:a,jwt:g,logger:B,redis:ne,pubsub:new k.RedisPubSub({publisher:re,subscriber:ie,connection:V}),knex:te,deviceInfo:{client:{type:"",name:"",version:"",engine:"",engineVersion:""},os:{name:"",version:"",platform:""},device:{type:"",brand:"",model:""},bot:null},startTime:0,token:{type:j.TokenType.access,id:"",uuid:"",roles:[],exp:0,iss:""}};if(!1!==X){const e=b.default(h.default);X.logFn=e=>B.session.info(e),Y.use(h.default({store:new e(X),secret:X.secret,genid:()=>S.v4(),resave:!1,saveUninitialized:!0,cookie:{secure:!0}})),Y.set("trust proxy",1)}if(Y.use(f.default({credentials:!0,origin:(e,t)=>t(null,!0)})),Y.use(m.default.json({limit:P.MAXIMUM_REQUEST_BODY_SIZE})),Y.use(m.default.urlencoded({extended:!0,limit:P.MAXIMUM_REQUEST_BODY_SIZE})),Y.use(p.default(W)),Y.use(G.headersMiddleware()),Z){const e=u.default.resolve(Z.staticDir);o.default.existsSync(e)||o.default.mkdirSync(e,{recursive:!0}),Y.use(Z.prefix,m.default.static(e))}if(Y.use(w.authMiddleware({context:ae,endpoint:i})),Y.use(I.requestHandlerMiddleware({context:ae})),U&&U.length&&U.forEach((e=>{Y.use(e({context:ae}))})),Y.use(L.default({context:ae})),J){const{accessToken:e}=x.configureTokens([""],ae);B.server.debug("New AccessToken was created special for GraphQL voyager",{accessToken:e}),console.log(""),console.log(`${c.default.yellow.bold("Note: ")}${c.default.yellow("An access token was created specifically for GraphQL voyager")}`),console.log(`${c.default.yellow("This token was expire at")} ${c.default.yellowBright.bold(new Date(Date.now()+18e5))}`),console.log(c.default.yellow("After the token expires, you must restart the application")),Y.use(q.voyager,E.express({endpointUrl:n,headersJS:JSON.stringify({Authorization:"Bearer "+e.token})}))}const se=e=>({queryTimeMs:d.performance.now()-e.context.startTime}),ue=new R.default({context:ae});return Y.use(n,y.graphqlHTTP((e=>r(this,void 0,void 0,(function*(){const t=R.default.extractToken(j.TokenType.access,e),n=yield ue.verifyToken(t);if(!n)throw new A.UnauthorizedError("Invalid token");if(n.type!==j.TokenType.access)throw new A.UnauthorizedError("Is not an access token");ae.token=n;const r=null==z?void 0:z.cert,i=new v.default;ae.deviceInfo=i.parse(e.headers["user-agent"]),ae.startTime=d.performance.now();const o=[...T||[]];return{context:ae,graphiql:K,extensions:H?se:void 0,schema:_.applyMiddleware(ee,...o),subscriptionEndpoint:`ws${r?"s":""}://localhost:${s}${$}`,customFormatErrorFn:e=>A.customFormatErrorFn({error:e,context:ae,debug:H}),validationRules:Q?[]:[C.DisableIntrospectionQueries]}}))))),B.server.debug("Application was created"),F.CronJobManager.addJob("__clearExpiredTokens",{cronTime:"* 0 5 * * *",onTick:()=>r(this,void 0,void 0,(function*(){yield ue.clearExpiredTokens()})),start:!0}),{app:Y,context:ae,schema:ee,routes:q}}}t.App=U,t.default=U},1353:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(2127),a=i(n(6980)),s=n(8026);t.default=e=>{const{context:t,endpoint:n}=e,{logger:i,deviceInfo:u}=t,d=o.Router(),l=new a.default({context:t});return d.post(n+"/get-access-token",((e,t)=>r(void 0,void 0,void 0,(function*(){const{body:n}=e,{login:r,password:o}=n,a=yield l.getAccountByCredentials(String(r),String(o));if(!a)return i.auth.info(`Authorization attempt with login «${r}» failed. Invalid login or password`),t.status(401).send({errors:[{message:"Invalid login or password"}]});if(a.status===s.AccountStatus.forbidden)return i.auth.info(`Authorization attempt with login «${r}» failed. Account locked`),t.status(401).send({errors:[{message:"Account locked"}]});i.auth.info(`Authorization attempt with login «${r}» success`);const d=yield l.registerTokens({uuid:a.id,deviceInfo:u});return t.status(200).send(d)})))),d.post(n+"/verify-token",((e,t)=>r(void 0,void 0,void 0,(function*(){const{body:n}=e,{token:r}=n,o=yield l.verifyToken(String(r));return!1===o?(i.auth.info("Token is invalid"),t.status(200).send({status:!1,reason:"Token is invalid",result:null})):(i.auth.info("Token verification success"),t.status(200).send({status:!0,reason:"Token is valid",result:o}))})))),d.post(n+"/refresh-token",((e,t)=>r(void 0,void 0,void 0,(function*(){const{body:n}=e,{token:r}=n,o=yield l.verifyToken(String(r));if(!o)return i.auth.info("Token is invalid",{payload:o}),t.status(400).send({errors:[{message:"Token is invalid"}]});if(o.type!==s.TokenType.refresh)return i.auth.info("Tried to refresh token by access token. Rejected",{payload:o}),t.status(400).send({errors:[{message:"Is not a refresh token"}]});if(!(yield l.checkTokenExist(o.id)))return i.auth.info("Tried to refresh token by revoked refresh token. Rejected",{payload:o}),t.status(400).send({errors:[{message:"This token was revoked"}]});yield l.revokeToken([o.associated,o.id]);const a=yield l.registerTokens({uuid:o.uuid,deviceInfo:u});return i.auth.info("Token refreshing success"),t.status(200).send(a)})))),d.post(n+"*",((e,t)=>{const{originalUrl:n}=e;return i.server.debug("Invalid post request "+n),t.status(404).send({errors:[{message:"The address is not served"}]})})),d.get(n+"*",((e,t)=>{const{originalUrl:n}=e;return i.server.debug("Invalid get request "+n),t.status(404).send({errors:[{message:"The address is not served"}]})})),d}},531:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authMiddleware=void 0;const i=r(n(1353));t.authMiddleware=i.default,t.default=i.default},7865:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Knex=t.knex=t.knexProvider=void 0;const s=n(630),u=a(n(2242)),d=a(n(5717));t.knex=d.default;const l=o(n(5717));t.Knex=l;const c=a(n(1289)),p=n(4723),f=n(5504);t.knexProvider=e=>{const{connection:t,logger:n,timezone:r,localTimezone:i,pool:o}=e,a={};p.types.setTypeParser(p.types.builtins.TIMESTAMP,"text",(e=>c.default.tz(e,i).toDate())),p.types.setTypeParser(p.types.builtins.TIMESTAMPTZ,"text",(e=>c.default.tz(e,i).toDate())),p.types.setTypeParser(p.types.builtins.NUMERIC,parseFloat),n.server.debug("pg-types configured");const l=d.default({client:f.DATABASE_CLIENT,connection:t,pool:Object.assign(Object.assign({},o),{afterCreate:(e,t)=>{e.query(`\n            SET TIMEZONE = '${r||"UTC"}';\n            SET CLIENT_ENCODING = ${f.DATABASE_CHARSET};\n          `,(i=>{i?n.sql.debug("Connection error",{err:i}):(n.sql.debug(`The TIMEZONE was set to "${r||"UTC"}"`),n.sql.debug(`The charset was set to "${f.DATABASE_CHARSET}"`)),t(i,e)}))}})});return l.on("query",(e=>{const t=e.__knexQueryUid;a[t]={startTime:s.performance.now()}})).on("query-response",((e,t,r)=>{const i=t.__knexQueryUid,o=s.performance.now()-a[i].startTime;n.sql.debug(r.toString(),{queryTime:o})})).on("query-error",((e,t)=>{n.sql.error(t.sql,{err:e,bindings:t.bindings})})),n.server.debug("Knex provider configured"),l.raw("SELECT 1+1 AS result").then((()=>(n.server.debug("Test the Database connection by trying to authenticate is OK"),!0))).catch((e=>{n.server.error(e.name,e),console.log(""),console.log(u.default.red("Database connection failure.")),console.log(u.default.red("Please check your database connection details.")),console.log(u.default.red("Make sure that the database is working properly.")),console.log("")})),l},t.default=t.knexProvider},265:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(7865),t)},5136:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends Error{constructor(e,t){super(e),this.name="BadRequestError",this.message=e,this.metaData=t,this.status=400,Object.setPrototypeOf(this,n.prototype)}}t.default=n},1940:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends Error{constructor(e,t){super(e),this.name="ForbiddenError",this.message=e,this.metaData=t,this.status=403,Object.setPrototypeOf(this,n.prototype)}}t.default=n},9589:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends Error{constructor(e,t){super(e),this.name="NotFoundError",this.message=e,this.metaData=t,this.status=404,Object.setPrototypeOf(this,n.prototype)}}t.default=n},6696:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends Error{constructor(e,t){super(e),this.name="ServerError",this.message=e,this.metaData=t,this.status=500,Object.setPrototypeOf(this,n.prototype)}}t.default=n},5960:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends Error{constructor(e,t){super(e),this.name="UnauthorizedError",this.message=e,this.metaData=t,this.status=401,Object.setPrototypeOf(this,n.prototype)}}t.default=n},6411:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.customFormatErrorFn=void 0;const i=r(n(2242)),o=r(n(5136)),a=r(n(1940)),s=r(n(9589)),u=r(n(6696)),d=r(n(5960));t.customFormatErrorFn=e=>{const{error:t,context:n,debug:r}=e,{logger:l,token:c}=n,{originalError:p}=t,f=t.stack.split("\n")||[];switch(!0){case p instanceof d.default:l.auth.error(p.message,Object.assign(Object.assign({},t),{meta:p.metaData,token:c,stack:f}));break;case p instanceof a.default:l.auth.error(p.message,Object.assign(Object.assign({},t),{meta:p.metaData,token:c,stack:f})),l.server.error(p.message,Object.assign(Object.assign({},t),{meta:p.metaData,token:c,stack:f}));break;case p instanceof o.default:case p instanceof s.default:case p instanceof u.default:l.server.error(p.message,Object.assign(Object.assign({},t),{meta:p.metaData,token:c,stack:f}));break;default:l.server.error("Error",Object.assign(Object.assign({},t),{token:c,stack:f}))}return r?(console.log(""),console.log(i.default.red("============== Caught the Error ==============")),console.log(""),p&&(p.message&&console.log(i.default.red(p.message)),p.metaData&&console.log(i.default.yellow("Error metadata"),p.metaData)),console.log(i.default.magenta("Access token payload"),c),console.log(""),console.log(i.default.red(t.stack)),console.log(""),console.log(i.default.red("============== End of Error report ==============")),console.log(""),{message:t.message,locations:t.locations,stack:t.stack?t.stack.split("\n"):[],path:t.path}):{message:t.message,locations:t.locations,path:t.path}},t.default=t.customFormatErrorFn},4384:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(6411));t.default=e=>(t,n,r,o)=>{const{context:a}=e;i.default({context:a,error:t,debug:!1})}},9892:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.customFormatErrorFn=t.UnauthorizedError=t.NotFoundError=t.ForbiddenError=t.BadRequestError=t.ServerError=void 0;const a=o(n(5136));t.BadRequestError=a.default;const s=o(n(6411));t.customFormatErrorFn=s.default;const u=o(n(1940));t.ForbiddenError=u.default;const d=o(n(9589));t.NotFoundError=d.default;const l=o(n(6696));t.ServerError=l.default;const c=o(n(5960));t.UnauthorizedError=c.default,i(n(7018),t)},7018:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},5363:()=>{},6514:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthService=t.Express=t.schemas=void 0;const u=o(n(2127));t.Express=u;const d=o(n(2706));t.schemas=d;const l=s(n(6980));t.AuthService=l.default,a(n(736),t),a(n(1400),t),a(n(5504),t),a(n(6737),t),a(n(265),t),a(n(9892),t)},6737:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(5651),t),i(n(1158),t),i(n(4267),t)},7809:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158));t.default=e=>{const{logDir:t}=e,{createLogger:n,transports:r}=o.Winston;return n({level:"info",format:a.default,transports:[new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_ACCESS}`,level:"warn",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES}),new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_ACCESS}`,level:"info",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES})]})}},1789:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158));t.default=e=>{const{logDir:t}=e,{createLogger:n,transports:r}=o.Winston;return n({level:"info",format:a.default,transports:[new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_AUTH}`,level:"info",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES}),new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_DEBUG}`,level:"debug",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES})]})}},5673:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158));t.default=e=>{const{logDir:t}=e,{createLogger:n,transports:r}=o.Winston;return n({level:"info",format:a.default,transports:[new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_HTTP}`,level:"info",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES})]})}},115:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sessionLogger=t.accessLogger=t.httpLogger=t.sqlLogger=t.authLogger=t.serverLogger=void 0;const i=r(n(7809));t.accessLogger=i.default;const o=r(n(1789));t.authLogger=o.default;const a=r(n(5673));t.httpLogger=a.default;const s=r(n(5990));t.serverLogger=s.default;const u=r(n(1075));t.sessionLogger=u.default;const d=r(n(9826));t.sqlLogger=d.default},5990:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158));t.default=e=>{const{logDir:t}=e,{createLogger:n,transports:r}=o.Winston;return n({level:"debug",format:a.default,transports:[new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_WARNINGS}`,level:"warn",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES}),new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_ERRORS}`,level:"error",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES}),new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_DEBUG}`,level:"debug",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES})]})}},1075:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158));t.default=e=>{const{logDir:t}=e,{createLogger:n,transports:r}=o.Winston;return n({level:"info",format:a.default,transports:[new r.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_SESSIONS}`,level:"info",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES})]})}},9826:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(7154),o=n(5651),a=r(n(1158)),{createLogger:s,transports:u,format:d}=o.Winston;t.default=e=>{const{logDir:t}=e;return s({level:"debug",format:a.default,transports:[new u.DailyRotateFile({filename:`${t}/${i.LOG_FILENAME_SQL}`,level:"debug",datePattern:i.LOG_DATE_PATTERNT,zippedArchive:!0,maxSize:i.LOG_MAX_SIZE,maxFiles:i.LOG_MAX_FILES}),new u.Console({level:"error",format:d.combine(d.colorize({all:!0}),d.simple())})]})}},4267:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.requestHandlerMiddleware=void 0;const i=r(n(5859));t.requestHandlerMiddleware=i.default},5859:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>{const{context:t}=e,{logger:n}=t;return(e,t,r)=>{const{method:i,originalUrl:o,headers:a}=e,s=String(e.headers["x-forwarded-for"]||"").replace(/:\d+$/,"")||e.connection.remoteAddress,u="127.0.0.1"===s||"::1"===s?"localhost":s,d={};return Object.entries(a).forEach((([e,t])=>{"authorization"!==e.toLowerCase()||"string"!=typeof t?d[e]=t:d[e]=t.substr(0,35)+"...[HIDDEN]"})),n.http.info(`${u} ${i} "${o}"`,{headers:d}),r()}}},5651:function(e,t,n){"use strict";var r=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Winston=t.configureLogger=t.logger=void 0;const o=i(n(944));t.Winston=o.default,n(2510);const a=n(115);let s;t.logger=s;const u=e=>{const{loggers:n}=e,i=r(e,["loggers"]);return t.logger=s=Object.assign({access:a.accessLogger(i),auth:a.authLogger(i),http:a.httpLogger(i),server:a.serverLogger(i),sql:a.sqlLogger(i),session:a.sessionLogger(i)},n),s};t.configureLogger=u,t.default=u},1158:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(5651),{format:i}=r.Winston;t.default=i.combine(i.metadata(),i.json(),i.timestamp({format:"YYYY-MM-DDTHH:mm:ssZZ"}),i.splat(),i.printf((e=>{const{timestamp:t,level:n,message:r,metadata:i}=e,o="{}"!==JSON.stringify(i)?i:null;return`${t} ${n}: ${r} ${o?JSON.stringify(o):""}`})))},6083:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.service=t.resolvers=t.typeDefs=void 0;const u=s(n(293));t.resolvers=u.default;const d=o(n(6854));t.typeDefs=d;const l=s(n(6980));t.service=l.default,a(n(8026),t)},7073:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(9892),a=i(n(6980)),s=n(481),u={revokeToken:(e,t,n)=>r(void 0,void 0,void 0,(function*(){const{pubsub:e}=n,{id:r}=t;try{const t=new a.default({context:n});return yield t.revokeToken(r),e.publish(s.SubscriptioTriggers.TOKEN_REVOKED,{tokenWasRevoked:[r]}),!0}catch(e){throw new o.ServerError("Failed to revoke token "+r,{id:r})}})),revokeAllTokens:(e,t,n)=>r(void 0,void 0,void 0,(function*(){const{pubsub:e}=n,{account:r}=t;try{const t=new a.default({context:n}),i=yield t.revokeAccountTokens(r);return e.publish(s.SubscriptioTriggers.TOKEN_REVOKED,{tokenWasRevoked:i}),!0}catch(e){throw new o.ServerError("Failed to revoke account tokens "+r,{account:r})}}))};t.default=u},481:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SubscriptioTriggers=void 0;const r=n(1400);var i;!function(e){e.TOKEN_REVOKED="token-revoked"}(i=t.SubscriptioTriggers||(t.SubscriptioTriggers={}));const o={tokenWasRevoked:{subscribe:r.withFilter(((e,t,n)=>n.pubsub.asyncIterator(i.TOKEN_REVOKED)),((e,t)=>e.tokenWasRevoked.includes(t.id)))}};t.default=o},293:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(7073)),o={Mutation:{auth:()=>({})},Subscription:r(n(481)).default,AuthMutation:i.default};t.default=o},6980:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(5747)),a=i(n(2773)),s=i(n(9722)),u=i(n(1289)),d=n(1231),l=n(9892),c=n(5504),p=n(8026);t.default=class{constructor(e){this.props=e}static cryptUserPassword(e){const t=a.default.genSaltSync(10);return a.default.hashSync(e,t)}getAccountByCredentials(e,t){return r(this,void 0,void 0,(function*(){const{context:n}=this.props,{knex:r}=n,i=yield r.select(["id","password","status","roles"]).from("accounts").where({login:e}).first();return i&&a.default.compareSync(t,String(i.password))?i:null}))}registerTokens(e){return r(this,void 0,void 0,(function*(){const{context:t}=this.props,{knex:n,logger:r}=t,i=yield n.select(["id","roles"]).from("accounts").where({id:e.uuid}).first();if("string"!=typeof i.id)throw new l.BadRequestError(`Account with id[${i.id}] not found`);const o=this.generateTokens({uuid:i.id,roles:i.roles});try{yield n("tokens").insert({id:o.accessToken.payload.id,account:o.accessToken.payload.uuid,type:p.TokenType.access,deviceInfo:e.deviceInfo,expiredAt:u.default(1e3*o.accessToken.payload.exp).format()})}catch(e){throw new l.ServerError("Failed to register access token",e)}try{yield n("tokens").insert({id:o.refreshToken.payload.id,account:o.refreshToken.payload.uuid,type:p.TokenType.refresh,associated:o.accessToken.payload.id,deviceInfo:e.deviceInfo,expiredAt:u.default(1e3*o.refreshToken.payload.exp).format()})}catch(e){throw new l.ServerError("Failed to register refresh token",e)}return r.auth.info("New Access token was registered",o.accessToken.payload),o}))}generateTokens(e,t){const{context:n}=this.props,r=(null==t?void 0:t.access)?t.access:n.jwt.accessTokenExpiresIn,i=(null==t?void 0:t.refresh)?t.refresh:n.jwt.refreshTokenExpiresIn;try{o.default.accessSync(n.jwt.privateKey)}catch(e){throw new l.ServerError("Failed to open JWT privateKey file",{err:e})}const a=o.default.readFileSync(n.jwt.privateKey),u=Object.assign(Object.assign({},e),{type:p.TokenType.access,id:d.v4(),exp:Math.floor(Date.now()/1e3)+Number(r),iss:n.jwt.issuer}),c=Object.assign(Object.assign({},e),{type:p.TokenType.refresh,id:d.v4(),associated:u.id,exp:Math.floor(Date.now()/1e3)+Number(i),iss:n.jwt.issuer}),f=s.default.sign(u,a,{algorithm:n.jwt.algorithm}),v=s.default.sign(c,a,{algorithm:n.jwt.algorithm});return{accessToken:{token:f,payload:Object.assign(Object.assign({},u),{type:p.TokenType.access})},refreshToken:{token:v,payload:Object.assign(Object.assign({},c),{type:p.TokenType.refresh})}}}revokeToken(e){return r(this,void 0,void 0,(function*(){const{context:t}=this.props,{logger:n,knex:r,redis:i}=t,o=Array.isArray(e)?e:[e];try{i.sadd(c.REDIS_TOKENS_BLACKLIST,o),n.auth.info("New tokens has been added in BlackList",{tokenIds:o})}catch(e){throw new l.ServerError("Failed to update Redis BlackList",{err:e})}(yield r("tokens").select(["tokens.account","tokens.id as access","refreshTokens.id as refresh"]).leftJoin("accounts","accounts.id","tokens.account").leftJoin("tokens as refreshTokens","refreshTokens.associated","tokens.id").whereIn("tokens.id",o)).forEach((e=>{n.auth.info(`Revoke Access Token ${e.access} for account ${e.account}`,{data:e}),n.auth.info(`Revoke Refresh Token ${e.refresh} for account ${e.account}`,{data:e})}))}))}isTokenRevoked(e){return r(this,void 0,void 0,(function*(){const{redis:t,logger:n}=this.props.context;try{const n=yield t.sismember(c.REDIS_TOKENS_BLACKLIST,e);return Boolean(n)}catch(e){throw n.server.error("Redis sismember error",{err:e}),new l.ServerError("Failed to check token",{err:e})}}))}revokeAccountTokens(e){return r(this,void 0,void 0,(function*(){const{knex:t}=this.props.context,n=(yield t("tokens").select(["id"]).where({account:e}).where("expiredAt",">=",t.raw("now()"))).map((e=>e.id));return n.length&&(yield this.revokeToken(n)),n}))}getTokensByIds(e){return r(this,void 0,void 0,(function*(){const{context:t}=this.props,{knex:n}=t;return yield n("tokens").select("*").whereIn("id",e)}))}clearExpiredTokens(){return r(this,void 0,void 0,(function*(){const{context:e}=this.props,{knex:t,redis:n,logger:r}=e,i=(yield t("tokens").select("id").where("expiredAt","<",t.raw("now()"))).map((e=>e.id));if(i.length)try{yield n.srem(c.REDIS_TOKENS_BLACKLIST,i)}catch(e){throw r.server.error("Redis srem error",{err:e}),new l.ServerError("Failed to remove data from BlackList",{err:e})}yield t("tokens").del().where("expiredAt","<",t.raw("now()"))}))}verifyToken(e){return r(this,void 0,void 0,(function*(){const{context:t}=this.props,{redis:n,logger:r}=t;let i;try{i=o.default.readFileSync(t.jwt.publicKey)}catch(e){throw r.server.error("Failed to read JWT key",{err:e}),new l.ServerError("Failed to read JWT key",e)}try{const t=s.default.verify(String(e),i);return(yield n.sismember(c.REDIS_TOKENS_BLACKLIST,t.id))?(r.auth.info("Token was revoked",{payload:t}),!1):t}catch(e){return r.auth.info("Invalid token"),r.server.error("Failed to validate the token",{err:e}),!1}}))}checkTokenExist(e){return r(this,void 0,void 0,(function*(){const{context:t}=this.props,{knex:n}=t;return null!==(yield n.select(["id"]).from("tokens").where({id:e}).first())}))}static extractTokenFromSubscription(e){if("object"==typeof e&&c.TOKEN_BEARER_KEY in e){const[t,n]=String(e[c.TOKEN_BEARER_KEY]).split(" ");if(t===c.TOKEN_BEARER&&""!==n)return String(n)}return""}static extractToken(e,t){const{headers:n}=t;if(e===p.TokenType.access&&c.TOKEN_BEARER_KEY.toLocaleLowerCase()in n){const[e,t]=String(n[c.TOKEN_BEARER_KEY.toLocaleLowerCase()]).split(" ");if(e===c.TOKEN_BEARER&&""!==t)return String(t)}return""}}},8026:(e,t)=>{"use strict";var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.TokenType=t.AccountStatus=void 0,(r=t.AccountStatus||(t.AccountStatus={})).allowed="allowed",r.forbidden="forbidden",(n=t.TokenType||(t.TokenType={})).access="access",n.refresh="refresh"},2706:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.scalar=t.common=t.info=t.auth=void 0;const s=o(n(6083));t.auth=s;const u=a(n(5003)),d=o(n(4440));t.info=d;const l=o(n(2685));t.scalar=l;const c={typeDefs:u.default};t.common=c},4440:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.resolvers=t.typeDefs=void 0;const s=a(n(2713));t.resolvers=s.default;const u=o(n(6719));t.typeDefs=u},765:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9504),i={name:()=>r.Developer.name,url:()=>r.Developer.url,email:()=>r.Developer.email};t.default=i},5310:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={echo:(e,t,n)=>{const{str:r}=t,{pubsub:i}=n;return i.publish("info",{info:r}),r}}},4571:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={developer:()=>({})}},6908:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={info:{subscribe:(e,t,n)=>n.pubsub.asyncIterator("info")}}},2713:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(765)),o=r(n(5310)),a=r(n(4571)),s={Query:{info:()=>({})},Mutation:{info:()=>({})},Subscription:r(n(6908)).default,InfoQuery:a.default,InfoMutation:o.default,Developer:i.default};t.default=s},9504:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Developer=void 0;const r=n(7154);t.Developer={name:r.DEV_INFO_DEVELOPER_NAME,url:r.DEV_INFO_DEVELOPER_URL,email:r.DEV_INFO_DEVELOPER_EMAIL}},2685:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.resolvers=t.typeDefs=void 0;const a=o(n(9597));t.resolvers=a;const s=o(n(8793));t.typeDefs=s},8732:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313),i=new RegExp(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/);t.default=new r.GraphQLScalarType({name:"Date",description:"Analogue of Date object",serialize(e){let t=e;if(!(t instanceof Date)&&"string"!=typeof t)throw new TypeError("Value is not an instance of Date, Date string: "+JSON.stringify(t));if("string"==typeof t&&(t=new Date,t.setTime(Date.parse(e))),Number.isNaN(t.getTime()))throw new TypeError("Value is not a valid Date: "+JSON.stringify(t));return[t.getFullYear(),("0"+(t.getMonth()+1)).slice(-2),("0"+t.getDate()).slice(-2)].join("-")},parseValue(e){const t=new Date(e);if(!i.test(e))throw new TypeError("Value is not a valid date only: "+e);if(Number.isNaN(t.getTime()))throw new TypeError("Value is not a valid Date: "+e);return t},parseLiteral(e){if(e.kind!==r.Kind.STRING)throw new r.GraphQLError("Can only parse strings to dates but got a: "+e.kind);if(!i.test(e.value))throw new TypeError("Value is not a valid date only: "+e.value);const t=new Date(e.value);if(Number.isNaN(t.getTime()))throw new r.GraphQLError("Value is not a valid Date: "+e.value);return t}})},4273:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313);t.default=new r.GraphQLScalarType({name:"DateTime",description:"Analogue of Date object",serialize(e){let t=e;if(!(t instanceof Date)&&"string"!=typeof t&&"number"!=typeof t)throw new TypeError("Value is not an instance of Date, Date string or number: "+JSON.stringify(t));if("string"==typeof t?(t=new Date,t.setTime(Date.parse(e))):"number"==typeof t&&(t=new Date(t)),Number.isNaN(t.getTime()))throw new TypeError("Value is not a valid Date: "+JSON.stringify(t));return t.toJSON()},parseValue(e){const t=new Date(e);if(Number.isNaN(t.getTime()))throw new TypeError("Value is not a valid Date: "+e);return t},parseLiteral(e){if(e.kind!==r.Kind.STRING&&e.kind!==r.Kind.INT)throw new r.GraphQLError("Can only parse strings & integers to dates but got a: "+e.kind);const t=new Date(e.kind===r.Kind.INT?Number(e.value):e.value);if(Number.isNaN(t.getTime()))throw new r.GraphQLError("Value is not a valid Date: "+e.value);return t}})},7088:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313),i=new RegExp(/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/);t.default=new r.GraphQLScalarType({name:"EmailAddress",description:"A field whose value conforms to the standard internet email address format as specified in RFC822: https://www.w3.org/Protocols/rfc822/.",serialize(e){if("string"!=typeof e)throw new TypeError("Value is not string: "+e);if(!i.test(e))throw new TypeError("Value is not a valid email address: "+e);return e},parseValue(e){if("string"!=typeof e)throw new TypeError("Value is not string");if(!i.test(e))throw new TypeError("Value is not a valid email address: "+e);return e},parseLiteral(e){if(e.kind!==r.Kind.STRING)throw new r.GraphQLError("Can only validate strings as email addresses but got a: "+e.kind);if(!i.test(e.value))throw new TypeError("Value is not a valid email address: "+e.value);return e.value}})},9922:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JSONObject=t.JSON=void 0;const r=n(9313);function i(e){return e}function o(e){if("object"!=typeof e||null===e||Array.isArray(e))throw new TypeError("JSONObject cannot represent non-object value: "+e);return e}function a(e,t){const n=Object.create(null);return e.fields.forEach((e=>{n[e.name.value]=s(e.value,t)})),n}function s(e,t){switch(e.kind){case r.Kind.STRING:case r.Kind.BOOLEAN:return e.value;case r.Kind.INT:case r.Kind.FLOAT:return parseFloat(e.value);case r.Kind.OBJECT:return a(e,t);case r.Kind.LIST:return e.values.map((e=>s(e,t)));case r.Kind.NULL:return null;case r.Kind.VARIABLE:{const n=e.name.value;return t?t[n]:void 0}default:return e.value}}t.JSON=new r.GraphQLScalarType({name:"JSON",description:"The `JSON` scalar type represents JSON values as specified by [ECMA-404](http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf).",serialize:i,parseValue:i,parseLiteral:s}),t.JSONObject=new r.GraphQLScalarType({name:"JSONObject",description:"The `JSONObject` scalar type represents JSON objects as specified by [ECMA-404](http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf).",serialize:o,parseValue:o,parseLiteral:a})},1245:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313);t.default=new r.GraphQLScalarType({name:"Money",description:"The value is stored in the smallest monetary unit.",serialize(e){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("Value is not an instance of string or number: "+JSON.stringify(e));return Number(e)},parseValue(e){if("string"==typeof e)throw new TypeError("Value is not a valid Integer: "+e);return parseInt(e,10)},parseLiteral(e){if(e.kind!==r.Kind.STRING&&e.kind!==r.Kind.INT)throw new r.GraphQLError("Can only parse strings & integers to money but got a: "+e.kind);try{return parseInt(e.value,10)}catch(t){throw new r.GraphQLError("Value is not a valid Money: "+e.value)}}})},5324:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313),i=new RegExp(/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/);t.default=new r.GraphQLScalarType({name:"Time",description:"Time string",serialize(e){if("string"!=typeof e)throw new TypeError("Value is not string: "+e);if(!i.test(e))throw new TypeError("Value is not a valid time: "+e);return 5===e.length?e+":00":e},parseValue(e){if("string"!=typeof e)throw new TypeError("Value is not string");if(!i.test(e))throw new TypeError("Value is not a valid time: "+e);return 5===e.length?e+":00":e},parseLiteral(e){if(e.kind!==r.Kind.STRING)throw new r.GraphQLError("Can only validate strings as time but got a: "+e.kind);if(!i.test(e.value))throw new TypeError("Value is not a valid time: "+e.value);return 5===e.value.length?e.value+":00":e.value}})},4991:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9313);t.default=new r.GraphQLScalarType({name:"URL",description:"A field whose value conforms to the standard URL format as specified in RFC3986: https://www.ietf.org/rfc/rfc3986.txt.",serialize:e=>new URL(e.toString()).toString(),parseValue:e=>new URL(e.toString()),parseLiteral(e){if(e.kind!==r.Kind.STRING)throw new r.GraphQLError("Can only validate strings as URLs but got a: "+e.kind);return new URL(e.value.toString())}})},9597:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JSONObject=t.JSON=t.URL=t.Time=t.Money=t.EmailAddress=t.DateTime=t.Date=void 0;const i=r(n(8732));t.Date=i.default;const o=r(n(4273));t.DateTime=o.default;const a=r(n(7088));t.EmailAddress=a.default;const s=n(9922);Object.defineProperty(t,"JSON",{enumerable:!0,get:function(){return s.JSON}}),Object.defineProperty(t,"JSONObject",{enumerable:!0,get:function(){return s.JSONObject}});const u=r(n(1245));t.Money=u.default;const d=r(n(5324));t.Time=d.default;const l=r(n(4991));t.URL=l.default},736:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(5363),i(n(7836),t),i(n(2363),t)},7684:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configureTokens=void 0;const i=n(1231),o=r(n(6980)),a=(e,t)=>new o.default({context:t}).generateTokens({uuid:i.v4(),roles:e},{access:2592e3,refresh:2592e3});t.configureTokens=a,t.default=a},7154:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LOG_MAZ_SIZE=t.LOG_MAZ_FILES=t.LOG_MAX_FILES=t.LOG_MAX_SIZE=t.LOG_DATE_PATTERNT=t.LOG_FILENAME_SESSIONS=t.LOG_FILENAME_ACCESS=t.LOG_FILENAME_SQL=t.LOG_FILENAME_WARNINGS=t.LOG_FILENAME_ERRORS=t.LOG_FILENAME_DEBUG=t.LOG_FILENAME_HTTP=t.LOG_FILENAME_AUTH=t.DEV_INFO_DEVELOPER_EMAIL=t.DEV_INFO_DEVELOPER_URL=t.DEV_INFO_DEVELOPER_NAME=t.MAXIMUM_REQUEST_BODY_SIZE=t.DEFAULT_SESSION_PATH=t.DEFAULT_SESSION_TTL=t.DEFAULT_SESSION_SECRET=t.DEFAULT_ROUTE_VOYAGER=t.DEFAULT_ROUTE_GRAPHIQL=t.DEFAULT_SERVER_TIMEZONE=t.DEFAULT_GRAPHQL_SUBSCRIPTION_ENDPOINT=t.DEFAULT_AUTH_ENDPOINT=t.DEFAULT_GRAPHQL_ENDPOINT=t.DEFAULT_SERVER_PORT=t.DATABASE_CLIENT=t.DATABASE_CHARSET=t.REDIS_IP_BLACKLIST=t.REDIS_TOKENS_BLACKLIST=t.TOKEN_BEARER=t.TOKEN_BEARER_KEY=void 0,t.TOKEN_BEARER_KEY="Authorization",t.TOKEN_BEARER="Bearer",t.REDIS_TOKENS_BLACKLIST="tokensBlackList",t.REDIS_IP_BLACKLIST="ipBlackList",t.DATABASE_CHARSET="UTF8",t.DATABASE_CLIENT="pg",t.DEFAULT_SERVER_PORT=4e3,t.DEFAULT_GRAPHQL_ENDPOINT="/graphql",t.DEFAULT_AUTH_ENDPOINT="/auth",t.DEFAULT_GRAPHQL_SUBSCRIPTION_ENDPOINT="/subscriptions",t.DEFAULT_SERVER_TIMEZONE="UTC",t.DEFAULT_ROUTE_GRAPHIQL="/graphiql",t.DEFAULT_ROUTE_VOYAGER="/voyager",t.DEFAULT_SESSION_SECRET="DCBUN0HUKGY4WGHAK5446GAJDFHSKA",t.DEFAULT_SESSION_TTL=3600,t.DEFAULT_SESSION_PATH="./sessions",t.MAXIMUM_REQUEST_BODY_SIZE="50mb",t.DEV_INFO_DEVELOPER_NAME="Via Profit",t.DEV_INFO_DEVELOPER_URL="https://via-profit.ru/",t.DEV_INFO_DEVELOPER_EMAIL="promo@via-profit.ru",t.LOG_FILENAME_AUTH="auth-%DATE%.log",t.LOG_FILENAME_HTTP="http-%DATE%.log",t.LOG_FILENAME_DEBUG="debug-%DATE%.log",t.LOG_FILENAME_ERRORS="errors-%DATE%.log",t.LOG_FILENAME_WARNINGS="warnings-%DATE%.log",t.LOG_FILENAME_SQL="sql-%DATE%.log",t.LOG_FILENAME_ACCESS="access-%DATE%.log",t.LOG_FILENAME_SESSIONS="sessions-%DATE%.log",t.LOG_DATE_PATTERNT="YYYY-MM-DD",t.LOG_MAX_SIZE="20m",t.LOG_MAX_FILES="14d",t.LOG_MAZ_FILES="14d",t.LOG_MAZ_SIZE="20m"},8537:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CronJobManager=void 0;const r=n(9148),i=n(9892),o={pool:new Map,logger:void 0};class a{static addJob(e,t){if(o.pool.get(e))throw new i.BadRequestError(`Cron job with name «${e}» already exists`,{jobName:e});const n=r.job(t);return o.logger&&(o.logger.server.debug(`New Cron job was added with name «${e}» at time ${t.cronTime}`,{jobConfig:t}),n.addCallback((()=>{o.logger.server.debug(`Called Cron job with name «${e}» at time ${t.cronTime}`,{jobConfig:t})}))),o.pool.set(e,n),n}static getJob(e){return o.pool.get(e)}static getPool(){return o.pool}}t.CronJobManager=a,a.configure=e=>{const{logger:t}=e;o.logger=t},t.default=a},6158:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DisableIntrospectionQueries=t.noIntrospectionAllowedMessage=void 0;const r=n(9313),i=["__Schema!","__Type!"];t.noIntrospectionAllowedMessage=(e,t)=>`Introspection has been disabled for this schema. The field "${e}" of type "${String(t)}" is not allowed.`,t.DisableIntrospectionQueries=e=>({Field(n){const o=e.getType();o&&i.indexOf(String(o))>=0&&e.reportError(new r.GraphQLError(t.noIntrospectionAllowedMessage(n.name.value,o)))}})},4819:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.downloadSchema=void 0;const o=i(n(5747)),a=i(n(5622)),s=n(8068);t.downloadSchema=e=>r(void 0,void 0,void 0,(function*(){const{endpoint:t,method:n,token:r,filename:i,headers:u}=e,d=yield fetch(t,{method:n||"POST",headers:Object.assign({"Content-Type":"application/json",Authorization:"Bearer "+r},u),body:JSON.stringify({query:s.getIntrospectionQuery()})});if(200!==d.status)throw new Error("Failed to send introspection request with status code "+d.status);const l=yield d.json(),c=s.printSchema(s.buildClientSchema(l.data));return o.default.writeFileSync(a.default.resolve(i),c)}))},3878:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.arrayOfIdsToArrayOfObjectIds=t.collateForDataloader=t.extractNodeIds=t.extractNodeField=t.buildQueryFilter=t.buildCursorConnection=t.convertWhereToKnex=t.applyAliases=t.convertBetweenToKnex=t.convertJsonToKnex=t.convertOrderByToKnex=t.nodeToEdge=t.getCursorPayload=t.makeNodeCursor=t.cursorToString=t.stringToCursor=t.TWhereAction=t.IDirectionRange=void 0;const i=r(n(1289)),o=n(9892);var a,s;(s=t.IDirectionRange||(t.IDirectionRange={})).ASC="ASC",s.DESC="DESC",function(e){e.EQ="=",e.NEQ="<>",e.GT=">",e.LT="<",e.GTE=">=",e.LTE="<=",e.IN="in",e.NOTIN="notIn",e.LIKE="like",e.ILIKE="ilike",e.NULL="IS NULL",e.NOTNULL="IS NOT NULL"}(a=t.TWhereAction||(t.TWhereAction={})),t.stringToCursor=e=>Buffer.from(String(e),"utf8").toString("base64"),t.cursorToString=e=>Buffer.from(e,"base64").toString("utf8"),t.makeNodeCursor=(e,n)=>t.stringToCursor([JSON.stringify(n),e].join("---")),t.getCursorPayload=e=>{try{const n=t.cursorToString(e).split("---")[0]||"";return JSON.parse(n)}catch(e){throw new o.ServerError("Failed to decode cursor payload",{err:e})}},t.nodeToEdge=(e,n,r)=>({node:e,cursor:t.makeNodeCursor(n,r)}),t.convertOrderByToKnex=e=>[...e||[]].map((({field:e,direction:t})=>({column:e,order:t}))),t.convertJsonToKnex=(e,t)=>e.raw(`'${JSON.stringify(t)}'::jsonb`),t.convertBetweenToKnex=(e,t,n)=>{const{aliases:r,timezone:o}=n||{aliases:{},timezone:"UTC"};if(void 0===t)return e;const a=new Map;return Object.entries(r||{}).forEach((([e,t])=>{(Array.isArray(t)?t:[t]).forEach((t=>{a.set(t,e)}))})),Object.entries(t).forEach((([t,n])=>{const r=a.get(t)||a.get("*");e.whereBetween(r?`${r}.${t}`:t,[n.start instanceof Date?i.default.tz(n.start,o).format():n.start,n.end instanceof Date?i.default.tz(n.end,o).format():n.end])})),e},t.applyAliases=(e,t)=>{const n=new Map;return Object.entries(t).forEach((([e,t])=>{(Array.isArray(t)?t:[t]).forEach((t=>{n.set(t,e)}))})),e.map((e=>{const[t,r,i]=e,o=n.get(t)||n.get("*");return[o?`${o}.${t}`:t,r,i]}))},t.convertWhereToKnex=(e,n,r)=>{if(void 0===n)return e;const i=[];return Array.isArray(n)&&n.forEach((([e,t,n])=>{i.push([e,t,n])})),Array.isArray(n)||Object.entries(n).forEach((([e,t])=>{i.push([e,a.EQ,t])})),[...r?t.applyAliases(i,r):i].forEach((([t,n,r])=>{switch(!0){case n===a.IN:e.whereIn(t,Array.isArray(r)?r:[r]);break;case n===a.NOTIN:e.whereNotIn(t,Array.isArray(r)?r:[r]);break;case n===a.NULL:e.whereNull(t);break;case n===a.NOTNULL:e.whereNotNull(t);break;default:e.where(t,n,r)}})),e},t.buildCursorConnection=(e,n)=>{const{nodes:r,totalCount:i,offset:o,limit:a,where:s,orderBy:u}=e,d=r.map(((e,r)=>t.nodeToEdge(e,n,{offset:(o||0)+r+1,limit:a,where:s||[],orderBy:u||[]})));return{totalCount:i,edges:d,pageInfo:{startCursor:d.length?d[0].cursor:void 0,endCursor:d.length?d[d.length-1].cursor:void 0,hasPreviousPage:(o||0)>0,hasNextPage:(o||0)+a<i}}},t.buildQueryFilter=e=>{const{first:n,last:r,after:i,before:o,offset:s,orderBy:u,filter:d,search:l,between:c}=e,p={limit:Math.max(Number(n||r)||30,0),orderBy:u||[],revert:!!r,where:[],search:!1,offset:Math.max(Number(s)||0,0),between:c||{}};if(i||o){const e=t.getCursorPayload(i||o);return Object.assign(Object.assign({},p),e)}return void 0!==d&&(Array.isArray(d)&&(p.where=d),Array.isArray(d)||Object.entries(d).forEach((([e,t])=>{Array.isArray(t)?p.where.push([e,a.IN,t]):p.where.push([e,a.EQ,t])}))),l&&Array.isArray(l)&&(p.search=l),l&&"field"in l&&(p.search=[l]),l&&"fields"in l&&Array.isArray(l.fields)&&(p.search=l.fields.map((e=>({field:e,query:l.query})))),p},t.extractNodeField=(e,t)=>[...e].map((e=>e[t])),t.extractNodeIds=e=>t.extractNodeField(e,"id"),t.collateForDataloader=(e,t,n)=>e.map((e=>t.find((t=>t.id===e))||(n?void 0:null))),t.arrayOfIdsToArrayOfObjectIds=e=>e.length?e.map((e=>({id:e}))):null},2668:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loadGraphQLConfig=t.replaceEnv=void 0;const i=r(n(5747)),o=r(n(5622));t.replaceEnv=e=>e.replace(/\$\{([A-Z0-9_]+)\}/gi,((e,t)=>process.env[t]?String(process.env[t]):t)),t.loadGraphQLConfig=e=>{if(!i.default.existsSync(e))throw new Error(`GraphQL config file ${e} not found`);const n=i.default.readFileSync(o.default.resolve("src/utils","../../.graphqlconfig"),"utf8");try{return JSON.parse(t.replaceEnv(n))}catch(t){throw console.error(t),new Error("Failed to parse GraphQL config file "+e)}}},690:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.headersMiddleware=void 0,t.headersMiddleware=()=>(e,t,n)=>{t.removeHeader("X-Powered-By"),t.setHeader("X-Developer","Via Profit"),n()},t.default=t.headersMiddleware},5504:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||r(t,e,n)},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DataLoader=void 0;const a=o(n(8712));t.DataLoader=a.default,i(n(4819),t),i(n(3878),t),i(n(8537),t),i(n(7154),t),i(n(2668),t)},2363:e=>{"use strict";e.exports=require("@graphql-tools/schema")},7836:e=>{"use strict";e.exports=require("@graphql-tools/utils")},2773:e=>{"use strict";e.exports=require("bcryptjs")},2242:e=>{"use strict";e.exports=require("chalk")},358:e=>{"use strict";e.exports=require("cookie-parser")},479:e=>{"use strict";e.exports=require("cors")},9148:e=>{"use strict";e.exports=require("cron")},8712:e=>{"use strict";e.exports=require("dataloader")},1050:e=>{"use strict";e.exports=require("device-detector-js")},2127:e=>{"use strict";e.exports=require("express")},1800:e=>{"use strict";e.exports=require("express-graphql")},5057:e=>{"use strict";e.exports=require("express-session")},5747:e=>{"use strict";e.exports=require("fs")},9313:e=>{"use strict";e.exports=require("graphql")},9967:e=>{"use strict";e.exports=require("graphql-middleware")},1621:e=>{"use strict";e.exports=require("graphql-redis-subscriptions")},7071:e=>{"use strict";e.exports=require("graphql-subscriptions")},3373:e=>{"use strict";e.exports=require("graphql-voyager/middleware")},8068:e=>{"use strict";e.exports=require("graphql/utilities")},8605:e=>{"use strict";e.exports=require("http")},7211:e=>{"use strict";e.exports=require("https")},6933:e=>{"use strict";e.exports=require("ioredis")},9722:e=>{"use strict";e.exports=require("jsonwebtoken")},5717:e=>{"use strict";e.exports=require("knex")},1289:e=>{"use strict";e.exports=require("moment-timezone")},5622:e=>{"use strict";e.exports=require("path")},630:e=>{"use strict";e.exports=require("perf_hooks")},4723:e=>{"use strict";e.exports=require("pg")},2682:e=>{"use strict";e.exports=require("session-file-store")},6376:e=>{"use strict";e.exports=require("subscriptions-transport-ws")},1231:e=>{"use strict";e.exports=require("uuid")},944:e=>{"use strict";e.exports=require("winston")},2510:e=>{"use strict";e.exports=require("winston-daily-rotate-file")}},t={};return function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(6514)})();