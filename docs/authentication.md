# Аутентификация и авторизация

> Via Profit services / **Core**


## Содержание

- [Аутентификация](#authentication)
- [Авторизация](#authorization)

## <a name="authentication"></a> Аутентификация

Сервер аутентификации стартует на том же хосте, но имеет отличный endpoint (По умолчанию: `/auth`).
Все запросы принимаются и отправляются в формате `json`, соответственно, сервер ожидает наличия заголовка `Content-Type: application/json`. Все параметры передаются в теле запроса. Метод отправки - `POST`

### Методы сервера аутентификации

| Метод                    | Параметры                                 | Ответ                                                                                                                                    |
| ------------------------ | ----------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `/auth/get-access-token` | `{"login": "user", "password": "pass"}`   | В случае успеха - access и refresh токены. В случае ошибки - Код 401 и текст ошибки                                                      |
| `/auth/refresh-token`    | `{"token": "iOiJSUzI1NiIsInR5cCI6Ik..."}` | В случае успеха - access и refresh токены. В случае ошибки - Код 401 и текст ошибки                                                      |
| `/auth/verify-token`     | `{"token": "1NiIsInR5cCI6IkpXVdGDss..."}` | В случае успеха ответ будет содержать поле `result` с информацией о токене. В случае недействительного токена поле `result` будет пустым |

Пример запроса Access Token для `curl`:

```bash
curl -i -X POST \
  -H "Content-Type:application/json" \
  -d \
'{
  "login": "dev",
  "password": "dev"
}' \
'https://localhost:3005/auth/get-access-token'

```

### Payload токена

Каждый токен содержит `payload` данные:

**Payload для Access токена**

| Параметр     | Значение                                                                                                                          |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------- |
| `type`       | Тип токена. Может иметь значение `access` для Access токена и `refresh` для Refresh токена                                        |
| `id`         | ID токена                                                                                                                         |
| `uuid`       | ID аккаунта, для которого выдан токен                                                                                             |
| `roles`      | Массив ролей аккаунта                                                                                                             |
| `exp`        | время в формате Unix Time, определяющее момент, когда токен станет не валидным (expiration)                                       |
| `iss`        | чувствительная к регистру строка или URI, которая является уникальным идентификатором стороны, генерирующей токен (issuer)        |
| `associated` | Параметр содержится только в payload у Refresh токена и определяет ID Access токена, с которым он (Refresh токен) является парным |

Пример `payload` для Access токена

```json
{
  "type": "access",
  "id": "b485d679-facc-4afe-b6a0-f17ab387db9b",
  "uuid": "97878833-61ea-41f0-aeae-ec9d4b887447",
  "roles": ["manager", "writer"],
  "exp": 1584939413,
  "iss": "viaprofit-services"
}
```

## <a name="authorization"></a> Авторизация

Любой запрос к GraphQL-серверу должен содержать Access Token в заголовке `Authorization` согласно шаблону:

`Authorization: Bearer <token>`

Пример заголовка:

`Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1dWlk...`

